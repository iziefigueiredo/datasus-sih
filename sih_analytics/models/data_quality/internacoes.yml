version: 2

sources:
  - name: public
    database: "{{ target.database }}"
    schema: public

    tables:
      - name: internacoes
        description: "Tabela de fatos principal contendo cada registro de internação hospitalar."
        
        columns:
          # --- Testes de Chaves e Integridade ---
          - name: '"N_AIH"'
            description: "Chave primária da internação (Número da AIH)."
            tests:
              - not_null
              - unique

          - name: '"CNES"'
            description: "Chave estrangeira para a tabela de hospitais."
            tests:
              - not_null
              - relationships:
                  to: source('public', 'hospital')
                  field: '"CNES"'

          - name: '"DIAG_PRINC"'
            description: "Chave estrangeira para o diagnóstico principal na tabela CID-10."
            tests:
              - not_null
              - relationships:
                  to: source('public', 'cid10')
                  field: '"CID"'
          
          - name: '"MUNIC_RES"'
            description: "Chave estrangeira para o município de residência."
            tests:
              - not_null
              - relationships:
                  to: source('public', 'municipios')
                  field: '"codigo_6d"'

          # --- Testes de Lógica de Negócio e Datas ---
          - name: '"DT_INTER"'
            description: "Data de internação do paciente."
            tests:
              - not_null

          - name: '"DT_SAIDA"'
            description: "Data de saída do paciente."
            tests:
              - not_null
           

          - name: '"DIAS_PERM"'
            description: "Total de dias de permanência."
            tests:
              - not_null
              

          # --- Testes de Validade e Plausibilidade ---
          - name: '"IDADE"'
            description: "Idade do paciente em anos."
            tests:
              - not_null
             

          - name: '"SEXO"'
            description: "Sexo do paciente."
            tests:
              - not_null
              - accepted_values:
                  values: ['1', '3']

          - name: '"VAL_TOT"'
            description: "Valor total da internação."
            tests:
              - not_null
              

          - name: '"VAL_SH"'
            description: "Valor dos serviços hospitalares."
            tests:
              - not_null
              
          - name: '"VAL_SP"'
            description: "Valor dos serviços profissionais."
            tests:
              - not_null

      - name: procedimentos
        description: "Tabela de fatos principal contendo cada registro de internação hospitalar."
        
        columns:
          # --- Testes de Chaves e Integridade ---
        - name: '"PROC_REA"'
          tests:
            - not_null
            - unique
  